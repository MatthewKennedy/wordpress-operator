name: Docker Build and Push

on:
  push:
    branches:
    - main
    tags:
    - '[0-9]+.[0-9]+.[0-9]+'

permissions:
  contents: read
  id-token: write

jobs:
  docker:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Extract tag version
      if: startsWith(github.ref, 'refs/tags/')
      id: extract_tag
      run: echo "TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v5
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Log in to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.17' # Matches GO_SUPPORTED_VERSIONS in Makefile
    - name: Install yq
      run: |
        sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/local/bin/yq
        sudo chmod +x /usr/local/bin/yq
        # Create the bin directory the Makefile expects if it doesn't exist
        mkdir -p bin
        cp /usr/local/bin/yq ./bin/yq

    - name: Build and Push with Make
      env:
        LOCAL_REGISTRY: "local-build"
        IMAGE_TAG: ${{ env.TAG || 'latest' }}
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          make kubebuilder.manifests
          make .kubebuilder.update.chart
          make build PLATFORMS=linux_amd64
          make -C images/wordpress-operator img.build BUILD_REGISTRY=${{ env.LOCAL_REGISTRY }}


            # The image was built as local-build/wordpress-operator-amd64:latest
            # Retag it to your actual ECR registry and specific version tag
            docker tag ${{ env.LOCAL_REGISTRY }}/wordpress-operator-amd64:latest \
                       ${{ steps.login-ecr.outputs.registry }}/wordpress-operator:${{ env.TAG }}

            docker push ${{ steps.login-ecr.outputs.registry }}/wordpress-operator:${{ env.TAG }}
          fi
